{% extends 'workshop_app/base.html' %}

{% block title %}
Workshop Statistics
{% endblock %}

{% block extra-dependencies %}
    <!-- Using assets from base.html (jQuery, Bootstrap, jQuery UI, Chart.js). Only add page-specific styles here. -->
    <style>
        .stats-toolbar { gap: .5rem; }
        .stats-toolbar .btn { min-width: 10rem; }
        #myChartPie { max-height: 420px; }
    </style>
{% endblock %}

{% block extra-custom-scripts %}
    <!-- Google GeoChart for the India map -->
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <!-- Data payload injected from server-side for charts/maps -->
    <script id="stats-data" type="application/json">{
        "workshop_count": {{ workshop_count|safe }},
        "workshoptype_labels": {{ workshoptype_count.0|safe }},
        "workshoptype_data": {{ workshoptype_count.1|safe }},
        "india_map": {{ india_map|safe }}
    }</script>
    <script>
        (function() {
            var dateToday = new Date();
            var upto = new Date();
            var dateFormat = 'yy-mm-dd';
            dateToday.setDate(dateToday.getDate() - 1);
            upto.setFullYear(dateToday.getFullYear() + 1);

            $(function () {
                var payload = {};
                try { payload = JSON.parse(document.getElementById('stats-data').textContent || '{}'); } catch(e) { payload = {}; }
                var from = $('#from').datepicker({
                    defaultDate: '+1w', changeMonth: true, changeYear: true, showButtonPanel: true,
                    maxDate: dateToday, dateFormat: dateFormat
                }).on('change', function () { to.datepicker('option', 'minDate', getDate(this)); });

                var to = $('#to').datepicker({
                    defaultDate: '+1w', changeMonth: true, changeYear: true, showButtonPanel: true,
                    minDate: dateToday, maxDate: upto, dateFormat: dateFormat
                }).on('change', function () { from.datepicker('option', 'maxDate', getDate(this)); });

                function getDate(element) {
                    var date;
                    try { date = $.datepicker.parseDate(dateFormat, element.value); }
                    catch (error) { date = null; }
                    return date;
                }

                var ctx1 = document.getElementById('myChartPie').getContext('2d');
                var myChart;
                function destroyChart() { if (myChart) { myChart.destroy(); myChart = null; } }

                $('.js-mode').on('click', function () {
                    var mode = $(this).data('mode');
                    $('.js-mode').removeClass('active'); $(this).addClass('active');
                    if (mode === 'NWPM') {
                        destroyChart();
                        $('#visualization').css('visibility', 'hidden');
                        myChart = new Chart(ctx1, {
                            type: 'bar',
                            data: {
                                labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                                datasets: [{
                                    label: 'Workshops per Month ' + dateToday.getFullYear(),
                                    data: payload.workshop_count || [],
                                    backgroundColor: 'rgba(77, 163, 255, 0.25)',
                                    borderColor: 'rgba(77, 163, 255, 0.85)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                legend: { labels: { fontColor: '#e6e8eb' } },
                                scales: { yAxes: [{ ticks: { beginAtZero: true, fontColor: '#e6e8eb' } }],
                                          xAxes: [{ ticks: { fontColor: '#e6e8eb' } }] }
                            }
                        });
                    } else if (mode === 'OWC') {
                        destroyChart();
                        $('#visualization').css('visibility', 'hidden');
                        myChart = new Chart(ctx1, {
                            type: 'pie',
                            data: {
                                labels: payload.workshoptype_labels || [],
                                datasets: [{
                                    data: payload.workshoptype_data || [],
                                    backgroundColor: [
                                        'rgba(77, 163, 255, .9)','rgba(255, 214, 102, .9)','rgba(52, 199, 89, .9)','rgba(255, 138, 62, .9)','rgba(191, 191, 191, .9)'
                                    ]
                                }]
                            },
                            options: { responsive: true, legend: { labels: { fontColor: '#e6e8eb' } } }
                        });
                    } else if (mode === 'MOIN') {
                        destroyChart();
                        var dWidth = $(window).width() * 0.9;
                        var dHeight = $(window).height() * 0.9;
                        $('#visualization').dialog({
                            resizable: false, draggable: true,
                            title: 'State wise Completed Workshops (India Map)',
                            closeOnEscape: true, stack: true, zIndex: 10000,
                            width: dWidth, height: dHeight, modal: true
                        });
                        $('#visualization').css('visibility', 'visible');
                        function drawVisualization() {
                            var data = google.visualization.arrayToDataTable(payload.india_map || []);
                            var opts = {
                                region: 'IN', domain: 'IN', displayMode: 'regions', resolution: 'provinces',
                                datalessRegionColor: 'transparent', colorAxis: { colors: ['#e6e6e6', '#ff8b3e'] }, legend: { position: 'top' }
                            };
                            var geochart = new google.visualization.GeoChart(document.getElementById('visualization'));
                            geochart.draw(data, opts);
                        }
                        if (window.google) {
                            google.load('visualization', '1.0', { packages: ['geochart'], callback: drawVisualization });
                        }
                    }
                });
                // Default selection: show monthly count bar chart on load
                $('.js-mode[data-mode="NWPM"]').first().trigger('click');
            });
        })();
    </script>
    <style>
        #visualization path { stroke-width:1; stroke:white; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Filters Sidebar -->
        {% if show_workshop_stats %}
        <div class="col-xl-3 col-lg-4 mb-4">
            <div class="card card-dark h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Filters</h5>
                    <a href="?" class="btn btn-sm btn-outline-light">Clear</a>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="from">From date:</label>
                            <input type="text" class="form-control" id="from" name="from" placeholder="yyyy-mm-dd">
                        </div>
                        <div class="form-group mb-3">
                            <label for="to">To date:</label>
                            <input type="text" class="form-control" id="to" name="to" placeholder="yyyy-mm-dd">
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-theme-info flex-fill" type="submit" name="View" value="View">View</button>
                            <button class="btn btn-theme-success flex-fill" type="submit" name="Download" value="Download">Download</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Content Area -->
        <div class="col-xl-9 col-lg-8">
            <div class="card card-dark mb-4">
                <div class="card-body d-flex flex-wrap stats-toolbar">
                    <button type="button" class="btn btn-theme js-mode" data-mode="NWPM"><i class="fa fa-bar-chart"></i> State chart</button>
                    <button type="button" class="btn btn-theme js-mode" data-mode="OWC"><i class="fa fa-pie-chart"></i> Workshops chart</button>
                    <button type="button" class="btn btn-theme js-mode" data-mode="MOIN"><i class="fa fa-map-o"></i> India map</button>
                </div>
                <div class="card-body">
                    <canvas id="myChartPie"></canvas>
                    <div id="visualization" style="width: 400px; height: 300px; display: block; margin: 1rem auto; visibility: hidden;"></div>
                </div>
            </div>

            {% if show_workshop_stats %}
            <div class="card card-dark">
                <div class="card-header"><h5 class="mb-0">Upcoming Workshops</h5></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Coordinator Name</th>
                                    <th>Institute Name</th>
                                    <th>Instructor Name</th>
                                    <th>Workshop Name</th>
                                    <th>Workshop Date</th>
                                    <th>Requested/Proposed By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% csrf_token %}
                                {% for workshop in upcoming_workshops %}
                                <tr>
                                    {% if workshop.proposed_workshop_date %}
                                        <td>{{ workshop.proposed_workshop_coordinator.get_full_name|capfirst }}</td>
                                        <td>{{ workshop.proposed_workshop_coordinator.profile.institute|capfirst }}</td>
                                        <td>{{ workshop.proposed_workshop_instructor.get_full_name }}</td>
                                        <td>{{ workshop.proposed_workshop_title.workshoptype_name }}</td>
                                        <td>{{ workshop.proposed_workshop_date|date }}</td>
                                        <td>Coordinator</td>
                                    {% else %}
                                        <td>{{ workshop.requested_workshop_coordinator.get_full_name|capfirst }}</td>
                                        <td>{{ workshop.requested_workshop_coordinator.profile.institute|capfirst }}</td>
                                        <td>{{ workshop.requested_workshop_instructor.get_full_name }}</td>
                                        <td>{{ workshop.requested_workshop_title.workshoptype_name }}</td>
                                        <td>{{ workshop.requested_workshop_date|date }}</td>
                                        <td>Instructor</td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr><td colspan="6" class="text-center text-muted">No workshops found for the selected range.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item {% if not upcoming_workshops.has_previous %}disabled{% endif %}">
                                <a class="page-link" href="{% if upcoming_workshops.has_previous %}?page={{ upcoming_workshops.previous_page_number }}{% else %}#{% endif %}">Previous</a>
                            </li>
                            <li class="page-item disabled"><span class="page-link">Page {{ upcoming_workshops.number }} of {{ upcoming_workshops.paginator.num_pages }}</span></li>
                            <li class="page-item {% if not upcoming_workshops.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{% if upcoming_workshops.has_next %}?page={{ upcoming_workshops.next_page_number }}{% else %}#{% endif %}">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">Permission to View Upcoming Workshops is set to false, please set it to true in settings.py</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
